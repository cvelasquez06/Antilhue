#!/bin/bash
IFS=""
year=$(date +%Y)
monthNow=$(date +"%m")
typeBackup=$1
directoryScript=$2
directoryExclude=$3
directoryDestinationBackup=$4
directoryRootTotal=$5
shift
shift
shift
shift
shift
array=( "$@" )
	for registers in ${array[@]}; do
		name=$(echo $registers | awk -F"," '{print $1}' )
		directoryToBackup=$(echo $registers | awk -F"," '{print $2}' )
		script=$(echo $registers | awk -F"," '{print $3}' )
		maxSizeFiles=$(echo $registers | awk -F"," '{print $4}' )
	 	excludeBackup=$(echo $registers | awk -F"," '{print $5}' )
	 	echo ""
	 	echo "START_FILE "$name
	 	if [ "$excludeBackup" != "" ];then
			module/file check $directoryExclude$excludeBackup
			if [ $? -ne 1 ];then
				excludeBackup=$directoryExclude$excludeBackup
			fi
		else
			excludeBackup="/tmp"
	    fi

		if [ "$maxSizeFiles" = "" ]; then
			maxSizeFiles=1000G
		fi

		if [ "$script" != "" ]; then
			module/script check $directoryScript$script
			if [ $? -ne 1 ];then
				echo "->execute script "$script
				start=$(date +'%s')
				module/script run $directoryScript$script
				time_elapsed=$(($(date +'%s') - $start))
				echo "->"$time_elapsed" second"
			fi
		fi
		
		dirDestinationBackupAll=$directoryDestinationBackup
		module/directory check $dirDestinationBackupAll
		if [ $? -eq 1 ];then
			mkdir -p $dirDestinationBackupAll
			module/directory check $dirDestinationBackupAll
			if [ $? -eq 1 ];then
				break;
			fi
		fi
		
		module/directory check $dirDestinationBackupAll$directoryToBackup
		if [ $? -eq 1 ];then
			mkdir -p $dirDestinationBackupAll$directoryToBackup
			module/directory check $dirDestinationBackupAll$directoryToBackup
			if [ $? -eq 1 ];then
				break;
			fi
		fi

		module/rsync $typeBackup $maxSizeFiles $directoryToBackup $dirDestinationBackupAll $excludeBackup $directoryRootTotal

		echo "END_FILE "$name
		echo ""
	done
